<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Character Creator</title>
  <style>
    @font-face {
      font-family: 'Skip Std B';
      src: url('./fonts/FOT-Skip Std B.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }

    body {
      font-family: sans-serif;
      margin: 15px;
      display: flex;
      justify-content: flex-start;
      align-items: flex-start;
      height: 100vh;
      background: url('./assets/p3underwater.png') no-repeat center center;
      background-size: cover;
    }
    #logo {
      position: fixed;
      top: 30px; /* distance from top */
      left: 50%;
      transform: translateX(-50%) scale(2);
      z-index: 10; /* make sure it appears above everything else */
      max-width: 200px; /* adjust as needed */
      height: auto;
    } 

    #characterContainer {
      position: relative;
      width: 228px;
      height: 228px;
      flex-shrink: 0;
    }

    #background {
      position: absolute;
      top: 156%;
      left: 215%;
      transform: translate(50%, 50%) scale(3.50);
      width: 100%;
      z-index: 0;
    }

    #character {
      position: absolute;
      top: 57%;
      left: 180%;
      width: 100%;
      z-index: 1;
      transform: scale(0.988);
      transform-origin: top left;
      transition: transform 0.2s, top 0.2s, left 0.2s;
    }

    #character img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
    }

    .leftPanel {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-right: 30px;
      min-width: 167px;
    }

    .characterDropdownContainer {
      margin-bottom: 23px;
      width: 152px;
    }

    .characterDropdownContainer label {
      color: #fff;
      font-weight: bold;
      margin-bottom: 4.5px;
      display: block;
    }

    .characterDropdown {
      width: 100%;
      font-size: 12px;
      padding: 3.8px 6px;
      border-radius: 4.5px;
      border: 1px solid #aaa;
      font-family: sans-serif;
      margin-bottom: 7.6px;
    }

    .optionsPanel {
      display: none;
      flex-direction: column;
      width: 152px;
    }

    .optionsPanel.active {
      display: flex;
    }

    .optionsGroup {
      margin-bottom: 13.7px;
    }

    .optionsLabel {
      color: #fff;
      font-weight: bold;
      margin-bottom: 4.5px;
      display: block;
    }

    .options {
      display: flex;
      flex-direction: row;
      gap: 7.6px;
      margin: 0;
    }

    .options img {
      width: 68px;
      height: 68px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 6px;
      background: #fff;
    }

    .options img.selected {
      border-color: #007BFF;
    }

    #overlayText, #overlayName {
      position: absolute;
      pointer-events: none;
      font-family: 'Skip Std B', sans-serif;
      user-select: none;
    }

    #overlayText {
      top: 377px;
      left: 293%;
      width: 100%;
      text-align: left;
      font-size: 16.7px;
      font-weight: bold;
      font-stretch: ultra-expanded;
      color: #fff;
      z-index: 2;
      padding-left: 7.6px;
      transform: scaleY(1.1);
      transform-origin: top;
    }

    #overlayName {
      top: 340px;
      left: 283%;
      width: 100%;
      text-align: left;
      font-size: 11.7px;
      font-weight: bold;
      color: #0CF0F4;
      z-index: 3;
      padding-left: 3.8px;
    }

    #nameInputContainer {
      top: 530px;
      left: 141%;
      width: 350px;
      position: absolute;
      height: 80px;
    }

    #nameInput {
      width: 350px;
      height: 60px;
      font-size: 18px;
      padding: 10px;
      box-sizing: border-box;
      border-radius: 5px;
    }

    #downloadBtn {
      margin-top: 20px;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      background: #007BFF;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    #downloadBtn:hover {
      background: #0056b3;
    }

    #backgroundText, #backgroundTextLine2, #backgroundTextLine3 {
      position: absolute;
      left: 10px;
      color: #fff;
      font-weight: bold;
      font-family: 'Skip Std B', sans-serif;
      z-index: 1;
    }

    #backgroundText a, #backgroundTextLine2 a, #backgroundTextLine3 a {
      color: #fff;
      text-decoration: underline;
      text-decoration-color: #030303;
      text-decoration-thickness: 2px;
      cursor: pointer;
    }

    #backgroundText { top: 500px; font-size: 16px; }
    #backgroundTextLine2 { top: 522px; font-size: 12px; }
    #backgroundTextLine3 { top: 539px; font-size: 12px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body>
  <img id="logo" src="./assets/p3rlogo.png" alt="Logo">
  <div class="leftPanel">
    <div class="characterDropdownContainer">
      <label for="characterDropdown">Choose Character:</label>
      <select id="characterDropdown" class="characterDropdown">
        <option value="" disabled selected>Select...</option>
        <option value="Aigis">Aigis</option>
        <option value="Junpei">Junpei</option>
        <!-- Add other characters as needed -->
      </select>
    </div>

    <div class="optionsPanel" id="optionsPanel">
      <div class="optionsGroup">
        <span class="optionsLabel">Choose Base</span>
        <div class="options" id="baseOptions"></div>
      </div>
      <div class="optionsGroup">
        <span class="optionsLabel">Choose Eyes</span>
        <div class="options" id="eyesOptions"></div>
      </div>
      <div class="optionsGroup">
        <span class="optionsLabel">Choose Mouth</span>
        <div class="options" id="mouthOptions"></div>
      </div>
    </div>

    <button id="downloadBtn">Download PNG</button>
  </div>

  <div id="characterContainer">
    <img id="background" src="./assets/p3rui.png">
    <div id="overlayName"></div>
    <div id="overlayText"></div>
    <div id="character">
      <img id="base" src="./assets/nothing/base1.png">
      <img id="eyes" src="./assets/nothing/eyes1.png">
      <img id="mouth" src="./assets/nothing/mouth1.png">
    </div>

    <div id="nameInputContainer">
      <label for="nameInput" style="color:#fff;font-weight:bold;">Dialogue:</label>
      <input type="text" id="nameInput" maxlength="100" placeholder="Your fate is in the cards...">
    </div>
  </div>

  <div id="backgroundText">
    <a href="https://github.com/kefnatyll/p3rgenerator" target="_blank">Code</a> made by kefnatyl.
  </div>
  <div id="backgroundTextLine2">
    Inspired by <a href="http://www.p5generator.com/" target="_blank">p5generator.com</a>.
  </div>
  <div id="backgroundTextLine3">
    All artwork by <a href="https://x.com/Atlus_West" target="_blank">Atlus</a>.
  </div>

  <script>
const characterTransforms = {
  Aigis: { scale: 1.034, top: "82%", left: "150%" },
  Junpei: { scale: 1.178, top: "87%", left: "141%" }
};

function applyCharacterTransform(character) {
  const charDiv = document.getElementById("character");
  if (characterTransforms[character]) {
    const t = characterTransforms[character];
    charDiv.style.transform = `scale(${t.scale})`;
    charDiv.style.top = t.top;
    charDiv.style.left = t.left;
  } else {
    charDiv.style.transform = "scale(0.988)";
    charDiv.style.top = "57%";
    charDiv.style.left = "180%";
  }
}

// Update characterAssets to nest eyes/mouth options under each base
const characterAssets = {
  Aigis: {
    base1: { eyes: ["assets/aigis/eyes1.png","assets/aigis/eyes2.png"], mouth: ["assets/aigis/mouth1.png","assets/aigis/mouth2.png"] },
    base2: { eyes: ["assets/aigis/eyes1.png","assets/aigis/eyes2.png"], mouth: ["assets/aigis/mouth1.png","assets/aigis/mouth2.png"] }
  },
  Junpei: {
    base1: { eyes: ["assets/junpei/eyes1.png","assets/junpei/eyes2.png"], mouth: ["assets/junpei/mouth1.png","assets/junpei/mouth2.png"] },
    base2: { eyes: ["assets/junpei/eyes3.png","assets/junpei/eyes4.png"], mouth: ["assets/junpei/mouth3.png","assets/junpei/mouth4.png"] }
  }
};

function setupOptions(containerId, targetId) {
  const container = document.getElementById(containerId);
  const imgs = container.querySelectorAll("img");
  const target = document.getElementById(targetId);
  imgs.forEach(img => {
    img.addEventListener("click", () => {
      target.src = img.src;
      imgs.forEach(i => i.classList.remove("selected"));
      img.classList.add("selected");
      // If base is selected, update eyes and mouth options
      if (targetId === "base") updateEyesMouth(img.dataset.base);
    });
  });
  if (imgs.length) imgs[0].classList.add("selected");
}

function populateBaseOptions(character) {
  const baseOptions = document.getElementById("baseOptions");
  baseOptions.innerHTML = "";
  if (!characterAssets[character]) return;

  Object.keys(characterAssets[character]).forEach((base, i) => {
    const img = document.createElement("img");
    img.src = `assets/${character.toLowerCase()}/${base}.png`; // assume base image paths follow this naming
    img.dataset.base = base;
    if (i === 0) img.classList.add("selected");
    baseOptions.appendChild(img);
  });

  setupOptions("baseOptions","base");
  updateEyesMouth(Object.keys(characterAssets[character])[0]); // initialize eyes/mouth for first base
}

function updateEyesMouth(base) {
  const character = characterDropdown.value;
  const eyesOptions = document.getElementById("eyesOptions");
  const mouthOptions = document.getElementById("mouthOptions");
  eyesOptions.innerHTML = "";
  mouthOptions.innerHTML = "";
  
  const eyes = characterAssets[character][base].eyes;
  const mouth = characterAssets[character][base].mouth;

  eyes.forEach((src, i) => {
    const img = document.createElement("img");
    img.src = src;
    if (i === 0) img.classList.add("selected");
    eyesOptions.appendChild(img);
  });

  mouth.forEach((src, i) => {
    const img = document.createElement("img");
    img.src = src;
    if (i === 0) img.classList.add("selected");
    mouthOptions.appendChild(img);
  });

  setupOptions("eyesOptions","eyes");
  setupOptions("mouthOptions","mouth");

  // set initial images
  document.getElementById("eyes").src = eyes[0];
  document.getElementById("mouth").src = mouth[0];
}

const characterDropdown = document.getElementById("characterDropdown");
const optionsPanel = document.getElementById("optionsPanel");
const overlayName = document.getElementById('overlayName');

characterDropdown.addEventListener("change", function() {
  const character = this.value;
  if (character) {
    optionsPanel.classList.add("active");
    populateBaseOptions(character);
    overlayName.textContent = character;
    applyCharacterTransform(character);
  }
});

const nameInput = document.getElementById('nameInput');
const overlayText = document.getElementById('overlayText');
nameInput.addEventListener('input', () => overlayText.textContent = nameInput.value);

document.getElementById("downloadBtn").addEventListener("click", async () => {
  const container = document.getElementById("characterContainer");
  const bg = document.getElementById("background");
  const character = document.getElementById("character");
  const overlayName = document.getElementById("overlayName");
  const overlayText = document.getElementById("overlayText");

  // Wait for all images inside the container to decode (safe guard)
  async function waitForImagesToDecode(parent) {
    const imgs = Array.from(parent.querySelectorAll("img"));
    await Promise.all(imgs.map(img => {
      // If browser supports decode()
      if (img.decode) {
        return img.complete ? img.decode().catch(() => {}) : img.decode().catch(() => {});
      }
      // Fallback: resolve when load or error fires
      return new Promise(resolve => {
        if (img.complete) return resolve();
        img.addEventListener("load", resolve);
        img.addEventListener("error", resolve);
      });
    }));
  }

  try {
    await waitForImagesToDecode(container);

    // compute union bounding rect of the visible pieces we want to capture
    const rects = [bg, character, overlayName, overlayText]
      .filter(Boolean)
      .map(el => el.getBoundingClientRect());

    if (!rects.length) throw new Error("No elements found to capture.");

    const left = Math.min(...rects.map(r => r.left));
    const top = Math.min(...rects.map(r => r.top));
    const right = Math.max(...rects.map(r => r.right));
    const bottom = Math.max(...rects.map(r => r.bottom));
    const width = Math.max(1, right - left);
    const height = Math.max(1, bottom - top);

    // scroll offsets (html2canvas expects document coordinates)
    const x = left + window.scrollX;
    const y = top + window.scrollY;

    // Optional: temporarily hide UI so it doesn't accidentally overlap capture area
    const leftPanel = document.querySelector('.leftPanel');
    const leftPanelPrevVisibility = leftPanel ? leftPanel.style.visibility : null;
    if (leftPanel) leftPanel.style.visibility = 'hidden';

    // capture only the computed region of the page
    const canvas = await html2canvas(document.body, {
      x, y, width, height,
      useCORS: true,          // try to use CORS for external images
      allowTaint: false,      // don't allow tainted images (safer)
      backgroundColor: null,  // keep transparency if desired; set to a color if you want a flat bg
      scale: Math.min(window.devicePixelRatio || 1, 2) // control final resolution
    });

    // restore UI visibility
    if (leftPanel) leftPanel.style.visibility = leftPanelPrevVisibility || '';

    // download the png
    const link = document.createElement("a");
    link.download = "character.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  } catch (err) {
    console.error("Download capture failed:", err);
    // Helpful diagnostics for the user
    let message = "Could not create image. Try the suggestions below:\n\n";
    message += "• Make sure your asset images are fully loaded (we wait for decode already).\n";
    message += "• If images are local files (file://), run a local dev server and open the page via http(s) instead.\n";
    message += "• If images come from another domain, enable CORS on the server and add crossorigin='anonymous' to <img> tags.\n";
    message += "\nError: " + (err && err.message ? err.message : String(err));
    alert(message);
  }
});
  </script>
</body>
</html>
